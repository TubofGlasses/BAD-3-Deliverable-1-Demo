{% extends 'base.html' %}
{% load static %}

{% block content %}
<div style="padding: 10px;">
    <div class="d-flex flex-column" style="height: calc(100vh - 130px); margin: 50px; background-color: transparent;">
        <div class="card flex-grow-1 p-3" style="background-color: white; border: none; border-radius: 15px;">
            <div class="card-body d-flex flex-column">

                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th scope="col" style="color: #0BB351">Checklists</th>
                            <th scope="col" class="text-end">
                                <form action="{% url 'create_checklist' %}" method="POST">
                                    {% csrf_token %}
                                    <button type="submit" class="btn" style="color: #ffffff; width: 120px; height: 30px; background-color: #0BB351; font-size: 12px;">Create Checklist</button>
                                </form>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for checklist in page_obj %}
                        <tr>
                            <td>
                                <button type="button" class="btn btn-link" data-bs-toggle="modal" data-bs-target="#checklistModal{{ checklist.id }}">
                                    {{ checklist.name }}
                                </button>
                            </td>
                            <td></td>
                        </tr>
            
                        <!-- Modal -->
                        <div class="modal fade" id="checklistModal{{ checklist.id }}" tabindex="-1" aria-labelledby="checklistModalLabel{{ checklist.id }}" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                    <form action="{% url 'update_checklist' checklist.id %}" method="POST" id="checklistForm{{ checklist.id }}" onsubmit="prepareFormSubmission('checklistForm{{ checklist.id }}')">
                                        {% csrf_token %}
                                        <div class="modal-header">
                                            <div class="d-flex align-items-center">
                                                <button type="button" id="editButton{{ checklist.id }}" onclick="toggleEditMode({{ checklist.id }})">
                                                    <img src="{% static 'edit_selected.png' %}" width="20" height="20" alt="Edit">
                                                </button>
                                                <input class="form-control border-0 p-0" type="text" name="checklist_name" value="{{ checklist.name }}" id="checklistName{{ checklist.id }}"
                                                    style="margin-left: 30px; width: 300px; outline: none; box-shadow: none;" readonly>
                                            </div>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div style="margin-left: 20px; margin-right: 20px; margin-bottom: 20px;">
                                                <!-- Dropdown boxes -->
                                                <div class="row">
                                                    <label for="docuType" class="col-form-label col-auto">Document Type</label>
                                                    <div class="col text-end">
                                                        <select class="form-control d-inline-block" id="docuType" name="docuType"
                                                                style="border-radius: 10px; background-color: #fff; width: 200px; appearance: none; background-image: url('data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'16\' height=\'16\' fill=\'%23000\' class=\'bi bi-caret-down-fill\' viewBox=\'0 0 16 16\'><path d=\'M7.247 11.14l-4.796-5.481A.5.5 0 0 1 2.5 5h10a.5.5 0 0 1 .372.842l-4.796 5.48a.5.5 0 0 1-.754 0z\'/></svg>'); background-repeat: no-repeat; background-position: right 0.75rem center;" disabled>
                                                            <option value="">Choose...</option>
                                                            {% for value, display_text in document_type_choices %}
                                                                <option value="{{ value }}">{{ display_text }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="row mt-3">
                                                    <label for="country" class="col-form-label col-auto">Country</label>
                                                    <div class="col text-end">
                                                        <select id="country" name="country" class="form-control d-inline-block"
                                                                style="border-radius: 10px; background-color: #fff; width: 200px; appearance: none; background-image: url('data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'16\' height=\'16\' fill=\'%23000\' class=\'bi bi-caret-down-fill\' viewBox=\'0 0 16 16\'><path d=\'M7.247 11.14l-4.796-5.481A.5.5 0 0 1 2.5 5h10a.5.5 0 0 1 .372.842l-4.796 5.48a.5.5 0 0 1-.754 0z\'/></svg>'); background-repeat: no-repeat; background-position: right 0.75rem center;" disabled>
                                                            <option value="">Country...</option>
                                                            <!-- Country options will be added dynamically -->
                                                        </select>
                                                    </div>
                                                </div>

                                            </div>
                                            <ul class="list-group borderless-item-list" id="item-list-{{ checklist.id }}">
                                                {% for item in checklist.items.all %}
                                                <li class="list-group-item d-flex align-items-center borderless-item" id="item-{{ item.id }}">
                                                    <div class="bullet me-2"></div> <!-- Green bullet point -->
                                                    <input type="text" class="form-control" value="{{ item.item }}" name="items[]" style="border: none; outline: none; box-shadow: none;" readonly>
                                                    <!-- Hidden field for tracking deletion -->
                                                    <input type="hidden" name="delete_items[]" id="delete-item-{{ item.id }}" value="" disabled>
                                                    <button type="button" class="btn btn-danger btn-sm ms-2 d-none delete-item-button" onclick="markForDeletion({{ item.id }})">X</button>
                                                </li>
                                                {% endfor %}
                                            </ul>
                                            <!-- Add Item Button and Container -->
                                            <div id="new-items-container-{{ checklist.id }}"></div>
                                            <button type="button" class="btn btn-secondary mt-2 d-none" onclick="addNewItemField({{ checklist.id }})">Add Item</button>
                                            <button type="submit" class="btn btn-primary mt-2 d-none" id="saveButton{{ checklist.id }}">Save Changes</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <style>
                            .deleted-item {
                                text-decoration: line-through;
                                opacity: 0.6; /* Reduce opacity for visual feedback */
                            }
                            
                            .bullet {
                                width: 8px;
                                height: 8px;
                                background-color: #0BB351; /* Green color */
                                border-radius: 0px; /* Square shape */
                            }

                            .borderless-item-list .borderless-item {
                                border-left: none;
                                border-right: none;
                            }

                            #editButton{{ checklist.id }} {
                                background: none;
                                border: none;
                                padding: 0;
                                position: absolute; /* Absolute positioning to control exact position */
                                top: 15px; /* Adjust based on required vertical position */
                            }
                        </style>
                        
                        {% endfor %}
                    </tbody>
                </table>

                <!-- Pagination controls -->

                <style>
                    .page-item.active .page-link {
                        background-color: #109E4C;
                        border-color: #0BB351; 
                        color: white;
                    }
        
                    .page-item .page-link {
                        color: #0BB351;
                    }
                </style>

                <nav aria-label="Page navigation" class="mt-3">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                        {% endif %}
                        {% for num in page_obj.paginator.page_range %}
                            <li class="page-item {% if page_obj.number == num %}active{% endif %}">
                                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                            </li>
                        {% endfor %}
                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>

            </div>
        </div>
    </div>
</div>

<script>
    function toggleEditMode(checklistId) {
        const nameInput = document.querySelector(`#checklistName${checklistId}`);
        const saveButton = document.getElementById(`saveButton${checklistId}`);
        const addItemButton = document.querySelector(`#checklistModal${checklistId} .btn-secondary`);
        const docTypeSelect = document.getElementById("docuType");
        const countrySelect = document.getElementById("country");
        const itemInputs = document.querySelectorAll(`#item-list-${checklistId} input[name="items[]"]`);
        const deleteButtons = document.querySelectorAll(`#item-list-${checklistId} .delete-item-button`);
    
        const isReadOnly = nameInput.hasAttribute('readonly');
    
        // Toggle read-only mode and borders
        nameInput.toggleAttribute('readonly', !isReadOnly);
        nameInput.classList.toggle('border', isReadOnly);
    
        // Toggle visibility of the add item button and save button
        addItemButton.classList.toggle('d-none', !isReadOnly);
        saveButton.classList.toggle('d-none', !isReadOnly);
    
        // Toggle dropdown visibility
        docTypeSelect.disabled = !isReadOnly;
        countrySelect.disabled = !isReadOnly;
    
        // Toggle read-only state for item inputs and show/hide delete buttons
        itemInputs.forEach(input => {
            input.toggleAttribute('readonly', !isReadOnly);
            input.classList.toggle('border', isReadOnly);
        });
        deleteButtons.forEach(button => {
            button.classList.toggle('d-none', !isReadOnly);
        });
    }
    
    function markForDeletion(itemId) {
        const deleteInput = document.getElementById(`delete-item-${itemId}`);
        const itemElement = document.getElementById(`item-${itemId}`);
    
        if (deleteInput && itemElement) {
            if (itemElement.classList.contains('deleted-item')) {
                // If the item is already marked for deletion, unmark it
                deleteInput.value = '';
                deleteInput.disabled = true;
                itemElement.classList.remove('deleted-item');
            } else {
                // Mark the item for deletion
                deleteInput.value = itemId;
                deleteInput.disabled = false;
                itemElement.classList.add('deleted-item');
            }
        }
    }
    
    let newItemsArray = [];
    
    // Function to add a new item field for the checklist
    function addNewItemField(checklistId) {
        const newItemContainer = document.getElementById(`new-items-container-${checklistId}`);
        if (!newItemContainer) {
            console.error(`Container not found for checklistId ${checklistId}`);
            return;
        }
    
        const newItemField = document.createElement('input');
        newItemField.setAttribute('type', 'text');
        newItemField.setAttribute('class', 'form-control mt-2');
        newItemField.setAttribute('placeholder', 'Add item');
    
        // Add an event listener to update the newItemsArray
        newItemField.addEventListener('input', (event) => {
            const index = newItemsArray.indexOf(event.target);
            if (event.target.value.trim()) {
                // Add or update the value in newItemsArray
                if (index === -1) {
                    newItemsArray.push(event.target);
                }
            } else {
                // Remove empty inputs from the array
                if (index !== -1) {
                    newItemsArray.splice(index, 1);
                }
            }
            // Log the current contents of the array to the console
            console.log('New Items Array:', newItemsArray.map(input => input.value.trim()).filter(Boolean));
        });
    
        newItemContainer.appendChild(newItemField);
    }
    
    // Modify the form submission to add the new items to a hidden input
    function prepareFormSubmission(formId) {
        const form = document.getElementById(formId);
    
        // Clear any existing hidden input
        const existingInput = form.querySelector('input[name="newItemsArray"]');
        if (existingInput) {
            form.removeChild(existingInput);
        }
    
        // Create hidden input to hold new items as a JSON string
        const hiddenInput = document.createElement('input');
        hiddenInput.setAttribute('type', 'hidden');
        hiddenInput.setAttribute('name', 'newItemsArray');
        hiddenInput.value = JSON.stringify(newItemsArray.map(input => input.value.trim()).filter(Boolean));
    
        form.appendChild(hiddenInput);
    }

    async function fetchCountries() {
        const countrySelect = document.getElementById('country');
        try {
            const response = await fetch('https://restcountries.com/v3.1/all');
            const countries = await response.json();
            countries.sort((a, b) => a.name.common.localeCompare(b.name.common));
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country.cca2; // Country code as value
                option.text = country.name.common; // Country name
                countrySelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error fetching countries:', error);
            countrySelect.innerHTML = '<option value="">Error loading countries</option>';
        }
    }

    // Call the function to fetch countries when the page loads
    document.addEventListener('DOMContentLoaded', fetchCountries);

</script>
{% endblock %}